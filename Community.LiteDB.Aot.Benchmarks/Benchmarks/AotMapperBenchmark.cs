using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Order;
using Community.LiteDB.Aot.Benchmarks.Models;
using Community.LiteDB.Aot.Benchmarks.Generators;
using Community.LiteDB.Aot.Mapping;
using LiteDB;

namespace Community.LiteDB.Aot.Benchmarks.Benchmarks;

/// <summary>
/// Tests Community.LiteDB.Aot performance with AOT-compiled mappers
/// </summary>
[MemoryDiagnoser]
[Orderer(SummaryOrderPolicy.FastestToSlowest)]
[RankColumn]
public class AotMapperBenchmark
{
    private TestEntityAotMapper _testMapper = null!;
    private DddValueObjectAotMapper _dddMapper = null!;
    private ComplexEntityAotMapper _complexMapper = null!;
    
    private TestEntity _testEntity = null!;
    private DddValueObject _dddEntity = null!;
    private ComplexEntity _complexEntity = null!;
    
    private BsonDocument _testEntityDoc = null!;
    private BsonDocument _dddEntityDoc = null!;
    private BsonDocument _complexEntityDoc = null!;

    [GlobalSetup]
    public void Setup()
    {
        // Setup AOT mappers
        _testMapper = new TestEntityAotMapper();
        _dddMapper = new DddValueObjectAotMapper();
        _complexMapper = new ComplexEntityAotMapper();
        
        // Generate test data
        _testEntity = TestDataGenerator.GenerateTestEntities(1)[0];
        _dddEntity = TestDataGenerator.GenerateDddEntities(1)[0];
        _complexEntity = TestDataGenerator.GenerateComplexEntities(1)[0];
        
        // Pre-serialize for deserialization tests
        _testEntityDoc = _testMapper.Serialize(_testEntity);
        _dddEntityDoc = _dddMapper.Serialize(_dddEntity);
        _complexEntityDoc = _complexMapper.Serialize(_complexEntity);
    }

    // ============================================
    // SIMPLE ENTITY (Object Initializer)
    // ============================================
    
    [Benchmark(Description = "AOT ObjectInit - Serialize Simple")]
    public BsonDocument AOT_Serialize_Simple()
    {
        return _testMapper.Serialize(_testEntity);
    }

    [Benchmark(Description = "AOT ObjectInit - Deserialize Simple")]
    public TestEntity AOT_Deserialize_Simple()
    {
        return _testMapper.Deserialize(_testEntityDoc);
    }

    // ============================================
    // DDD VALUE OBJECT (Expression Trees)
    // ============================================
    
    [Benchmark(Description = "AOT ExpressionTree - Serialize DDD")]
    public BsonDocument AOT_Serialize_Ddd()
    {
        return _dddMapper.Serialize(_dddEntity);
    }

    [Benchmark(Description = "AOT ExpressionTree - Deserialize DDD")]
    public DddValueObject AOT_Deserialize_Ddd()
    {
        return _dddMapper.Deserialize(_dddEntityDoc);
    }

    // ============================================
    // COMPLEX ENTITY (Nested + Collections)
    // ============================================
    
    [Benchmark(Description = "AOT Nested - Serialize Complex")]
    public BsonDocument AOT_Serialize_Complex()
    {
        return _complexMapper.Serialize(_complexEntity);
    }

    [Benchmark(Description = "AOT Nested - Deserialize Complex")]
    public ComplexEntity AOT_Deserialize_Complex()
    {
        return _complexMapper.Deserialize(_complexEntityDoc);
    }
}

// Placeholder mappers (will be generated by source generator)
internal class TestEntityAotMapper : IEntityMapper<TestEntity>
{
    public string CollectionName => "test";
    public string IdFieldName => "_id";

    public BsonDocument Serialize(TestEntity entity)
    {
        var doc = new BsonDocument
        {
            ["_id"] = entity.Id,
            ["Name"] = entity.Name,
            ["Description"] = entity.Description,
            ["CreatedAt"] = entity.CreatedAt,
            ["IsActive"] = entity.IsActive,
            ["Score"] = entity.Score
        };
        return doc;
    }

    public TestEntity Deserialize(BsonDocument doc)
    {
        return new TestEntity
        {
            Id = doc["_id"].AsInt32,
            Name = doc["Name"].AsString,
            Description = doc["Description"].AsString,
            CreatedAt = doc["CreatedAt"].AsDateTime,
            IsActive = doc["IsActive"].AsBoolean,
            Score = doc["Score"].AsDouble
        };
    }

    public BsonValue GetId(TestEntity entity) => entity.Id;
    public void SetId(TestEntity entity, BsonValue id) => entity.Id = id.AsInt32;
}

internal class DddValueObjectAotMapper : IEntityMapper<DddValueObject>
{
    // Expression Tree compiled setter (simulated for benchmark)
    private static readonly Action<DddValueObject, string>? _setName;
    private static readonly Action<DddValueObject, decimal>? _setAmount;
    private static readonly Action<DddValueObject, string>? _setCurrency;
    private static readonly Action<DddValueObject, DateTime>? _setTimestamp;

    static DddValueObjectAotMapper()
    {
        // Simplified: in real code this would be Expression.Lambda.Compile()
        // For benchmark purposes, we use reflection as baseline
        var nameField = typeof(DddValueObject).GetField("<Name>k__BackingField",
            System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        var amountField = typeof(DddValueObject).GetField("<Amount>k__BackingField",
            System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        var currencyField = typeof(DddValueObject).GetField("<Currency>k__BackingField",
            System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        var timestampField = typeof(DddValueObject).GetField("<Timestamp>k__BackingField",
            System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);

        if (nameField != null)
            _setName = (obj, val) => nameField.SetValue(obj, val);
        if (amountField != null)
            _setAmount = (obj, val) => amountField.SetValue(obj, val);
        if (currencyField != null)
            _setCurrency = (obj, val) => currencyField.SetValue(obj, val);
        if (timestampField != null)
            _setTimestamp = (obj, val) => timestampField.SetValue(obj, val);
    }

    public string CollectionName => "ddd";
    public string IdFieldName => "_id";

    public BsonDocument Serialize(DddValueObject entity)
    {
        return new BsonDocument
        {
            ["_id"] = entity.Id,
            ["Name"] = entity.Name,
            ["Amount"] = entity.Amount,
            ["Currency"] = entity.Currency,
            ["Timestamp"] = entity.Timestamp
        };
    }

    public DddValueObject Deserialize(BsonDocument doc)
    {
        var obj = (DddValueObject)System.Runtime.Serialization.FormatterServices
            .GetUninitializedObject(typeof(DddValueObject));

        obj.Id = doc["_id"].AsInt32;
        _setName?.Invoke(obj, doc["Name"].AsString);
        _setAmount?.Invoke(obj, doc["Amount"].AsDecimal);
        _setCurrency?.Invoke(obj, doc["Currency"].AsString);
        _setTimestamp?.Invoke(obj, doc["Timestamp"].AsDateTime);

        return obj;
    }

    public BsonValue GetId(DddValueObject entity) => entity.Id;
    public void SetId(DddValueObject entity, BsonValue id) => entity.Id = id.AsInt32;
}

internal class ComplexEntityAotMapper : IEntityMapper<ComplexEntity>
{
    public string CollectionName => "complex";
    public string IdFieldName => "_id";

    public BsonDocument Serialize(ComplexEntity entity)
    {
        var doc = new BsonDocument
        {
            ["_id"] = entity.Id,
            ["Title"] = entity.Title,
            ["Address"] = new BsonDocument
            {
                ["Street"] = entity.Address.Street,
                ["City"] = entity.Address.City,
                ["Country"] = entity.Address.Country
            },
            ["Tags"] = new BsonArray(entity.Tags.Select(t => new BsonDocument
            {
                ["Name"] = t.Name,
                ["Color"] = t.Color
            })),
            ["UpdatedAt"] = entity.UpdatedAt
        };
        return doc;
    }

    public ComplexEntity Deserialize(BsonDocument doc)
    {
        return new ComplexEntity
        {
            Id = doc["_id"].AsInt32,
            Title = doc["Title"].AsString,
            Address = new NestedAddress
            {
                Street = doc["Address"]["Street"].AsString,
                City = doc["Address"]["City"].AsString,
                Country = doc["Address"]["Country"].AsString
            },
            Tags = doc["Tags"].AsArray.Select(t => new NestedTag
            {
                Name = t["Name"].AsString,
                Color = t["Color"].AsString
            }).ToList(),
            UpdatedAt = doc["UpdatedAt"].AsDateTime
        };
    }

    public BsonValue GetId(ComplexEntity entity) => entity.Id;
    public void SetId(ComplexEntity entity, BsonValue id) => entity.Id = id.AsInt32;
}
